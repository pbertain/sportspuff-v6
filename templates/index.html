<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sportspuff - Sports Teams & Stadiums</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet">
</head>
<body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('index') }}">
                    <img src="https://www.splitsp.lat/logos/sportspuff/sportspuff-logo.png" alt="Sportspuff" style="height: 200px; margin-right: 20px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                    <i class="fas fa-baseball-ball me-2" style="display: none;"></i>Sportspuff
                </a>
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{{ url_for('teams') }}">Teams</a>
                    <a class="nav-link" href="{{ url_for('stadiums') }}">Stadiums</a>
                    <a class="nav-link" href="{{ url_for('api_teams') }}" target="_blank">API</a>
                    <a class="nav-link" href="{{ url_for('admin_panel') }}">Admin Panel</a>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Leagues
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='MLB') }}">MLB</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='NFL') }}">NFL</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='NBA') }}">NBA</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='NHL') }}">NHL</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='MLS') }}">MLS</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='WNBA') }}">WNBA</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('league_page', league_name='IPL') }}">IPL</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

    <div class="container my-5">
        {% if not db_available %}
        <div class="alert alert-warning text-center mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Database Not Available</strong> - The application is running in demo mode. 
            Database setup is pending. Teams and stadiums will appear once the database is configured.
        </div>
        {% endif %}

        <!-- Scores & Schedules Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="text-center mb-4 fade-in-up">
                    <h2 style="font-size: 2rem; margin: 0 0 20px 0;">üìÖ Schedules & üèÜ Scores</h2>
                </div>
                <div class="d-flex justify-content-center gap-3 mb-3 flex-wrap">
                    <div class="mb-2">
                        <label for="league-select" class="form-label text-white fw-bold">League:</label>
                        <select id="league-select" class="form-select" style="min-width: 120px;">
                            <option value="all" selected>All (NBA, NHL & NFL)</option>
                            <option value="nba">NBA</option>
                            <option value="nhl">NHL</option>
                            <option value="nfl">NFL</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="timezone-select" class="form-label text-white fw-bold">Timezone:</label>
                        <select id="timezone-select" class="form-select" style="min-width: 200px;">
                            <optgroup label="US/Canada">
                                <option value="et">Eastern Time (ET)</option>
                                <option value="ct">Central Time (CT)</option>
                                <option value="mt">Mountain Time (MT)</option>
                                <option value="pt" selected>Pacific Time (PT)</option>
                            </optgroup>
                            <optgroup label="All Timezones">
                                <option value="America/New_York">America/New_York</option>
                                <option value="America/Chicago">America/Chicago</option>
                                <option value="America/Denver">America/Denver</option>
                                <option value="America/Los_Angeles">America/Los_Angeles</option>
                                <option value="America/Toronto">America/Toronto</option>
                                <option value="America/Vancouver">America/Vancouver</option>
                                <option value="America/Edmonton">America/Edmonton</option>
                                <option value="America/Winnipeg">America/Winnipeg</option>
                                <option value="America/Halifax">America/Halifax</option>
                                <option value="America/St_Johns">America/St_Johns</option>
                                <option value="Europe/London">Europe/London</option>
                                <option value="Europe/Paris">Europe/Paris</option>
                                <option value="Europe/Berlin">Europe/Berlin</option>
                                <option value="Asia/Tokyo">Asia/Tokyo</option>
                                <option value="Asia/Shanghai">Asia/Shanghai</option>
                                <option value="Australia/Sydney">Australia/Sydney</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div id="scores-schedules-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading scores and schedules...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- League Info Section -->
        <div id="leagues" class="row mt-5">
            <div class="col-12">
                <h2 class="text-center mb-5 fade-in-up">
                    <i class="fas fa-trophy me-2"></i>League Info
                </h2>
                
                <div class="league-grid">
                    <!-- MLB -->
                    <a href="{{ url_for('league_page', league_name='MLB') }}" class="league-card mlb fade-in-up" data-league="MLB">
                        <div class="league-logo">
                            <img src="{{ 'MLB' | get_league_logo }}" alt="MLB Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-baseball-ball" style="color: var(--mlb-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">Major League Baseball</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'MLB') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- NFL -->
                    <a href="{{ url_for('league_page', league_name='NFL') }}" class="league-card nfl fade-in-up" data-league="NFL">
                        <div class="league-logo">
                            <img src="{{ 'NFL' | get_league_logo }}" alt="NFL Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-football-ball" style="color: var(--nfl-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">National Football League</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'NFL') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- NBA -->
                    <a href="{{ url_for('league_page', league_name='NBA') }}" class="league-card nba fade-in-up" data-league="NBA">
                        <div class="league-logo">
                            <img src="{{ 'NBA' | get_league_logo }}" alt="NBA Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-basketball-ball" style="color: var(--nba-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">National Basketball Association</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'NBA') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- NHL -->
                    <a href="{{ url_for('league_page', league_name='NHL') }}" class="league-card nhl fade-in-up" data-league="NHL">
                        <div class="league-logo">
                            <img src="{{ 'NHL' | get_league_logo }}" alt="NHL Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-hockey-puck" style="color: var(--nhl-accent-dark); display: none;"></i>
                        </div>
                        <h3 class="league-name">National Hockey League</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'NHL') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- MLS -->
                    <a href="{{ url_for('league_page', league_name='MLS') }}" class="league-card mls fade-in-up" data-league="MLS">
                        <div class="league-logo">
                            <img src="{{ 'MLS' | get_league_logo }}" alt="MLS Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-futbol" style="color: var(--mls-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">Major League Soccer</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'MLS') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- WNBA -->
                    <a href="{{ url_for('league_page', league_name='WNBA') }}" class="league-card wnba fade-in-up" data-league="WNBA">
                        <div class="league-logo">
                            <img src="{{ 'WNBA' | get_league_logo }}" alt="WNBA Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-basketball-ball" style="color: var(--wnba-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">Women's National Basketball Association</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'WNBA') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                    
                    <!-- IPL -->
                    <a href="{{ url_for('league_page', league_name='IPL') }}" class="league-card ipl fade-in-up" data-league="IPL">
                        <div class="league-logo">
                            <img src="{{ 'IPL' | get_league_logo }}" alt="IPL Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <i class="fas fa-cricket" style="color: var(--ipl-accent); display: none;"></i>
                        </div>
                        <h3 class="league-name">Indian Premier League</h3>
                        <p class="league-count">{{ league_stats | selectattr('league', 'equalto', 'IPL') | map(attribute='count') | first or 0 }} Teams</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p>&copy; 2025 SportsPuff. Part of the CloudPuff‚Ñ¢ family!</p>
            <p class="mt-2">
                <a href="https://www.elementspuff.net/static/img/powered-by-puhfph-cloud-logo.png" target="_blank" style="text-decoration: none; color: white;">
                    Powered by CloudPuff‚Ñ¢
                </a>
            </p>
            <div class="mt-3">
                <a href="https://www.elementspuff.net/static/img/powered-by-puhfph-cloud-logo.png" target="_blank">
                    <img src="https://www.elementspuff.net/static/img/powered-by-puhfph-cloud-logo.png" alt="Powered by CloudPuff‚Ñ¢" style="height: 80px; opacity: 0.9;" onerror="this.style.display='none';">
                </a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/contrast.js') }}"></script>
    <script>
        // Team colors from database (passed from server) - includes NBA and NHL
        const allTeamColors = {{ team_colors | tojson | safe }};
        
        // Fetch and display scores and schedules
        async function loadScoresAndSchedules() {
            const container = document.getElementById('scores-schedules-container');
            const leagueSelect = document.getElementById('league-select');
            const timezoneSelect = document.getElementById('timezone-select');
            
            const league = leagueSelect.value;
            const timezone = timezoneSelect.value;
            const leagueUpper = league.toUpperCase();
            
            try {
                // Call API directly - proxy will handle CORS via Flask-CORS
                // Try proxy first, fallback to direct API call if proxy fails
                const API_BASE = '{{ API_BASE_URL }}/api/v1';
                const proxyScheduleUrl = '{{ url_for("proxy_schedule", league="nba", date="today") }}';
                const proxyScoresUrl = '{{ url_for("proxy_scores", league="nba", date="today") }}';
                
                let scheduleData, scoresData;
                
                async function fetchWithFallback(proxyUrl, directUrl) {
                    try {
                        // Try proxy first
                        const proxyRes = await fetch(proxyUrl);
                        if (proxyRes.ok) {
                            return await proxyRes.json();
                        }
                        // If proxy fails, try direct API call
                        console.warn(`Proxy failed (${proxyRes.status}), trying direct API call`);
                        const directRes = await fetch(directUrl, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        if (!directRes.ok) {
                            throw new Error(`API error: ${directRes.status}`);
                        }
                        return await directRes.json();
                    } catch (error) {
                        // If both fail, try direct API as last resort
                        console.warn(`Both proxy and direct failed, retrying direct:`, error);
                        const directRes = await fetch(directUrl, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        if (!directRes.ok) {
                            throw new Error(`API error: ${directRes.status} - ${error.message}`);
                        }
                        return await directRes.json();
                    }
                }
                
                if (league === 'all') {
                    // For "all", fetch NBA, NHL, and NFL separately and combine
                    const nbaScheduleProxy = proxyScheduleUrl.replace(/\/nba\//, '/nba/') + `?tz=${timezone}`;
                    const nbaScoresProxy = proxyScoresUrl.replace(/\/nba\//, '/nba/') + `?tz=${timezone}`;
                    const nhlScheduleProxy = proxyScheduleUrl.replace(/\/nba\//, '/nhl/') + `?tz=${timezone}`;
                    const nhlScoresProxy = proxyScoresUrl.replace(/\/nba\//, '/nhl/') + `?tz=${timezone}`;
                    const nflScheduleProxy = proxyScheduleUrl.replace(/\/nba\//, '/nfl/') + `?tz=${timezone}`;
                    const nflScoresProxy = proxyScoresUrl.replace(/\/nba\//, '/nfl/') + `?tz=${timezone}`;
                    
                    const nbaScheduleDirect = `${API_BASE}/schedule/nba/today?tz=${timezone}`;
                    const nbaScoresDirect = `${API_BASE}/scores/nba/today?tz=${timezone}`;
                    const nhlScheduleDirect = `${API_BASE}/schedule/nhl/today?tz=${timezone}`;
                    const nhlScoresDirect = `${API_BASE}/scores/nhl/today?tz=${timezone}`;
                    const nflScheduleDirect = `${API_BASE}/schedule/nfl/today?tz=${timezone}`;
                    const nflScoresDirect = `${API_BASE}/scores/nfl/today?tz=${timezone}`;
                    
                    const [nbaSchedule, nbaScores, nhlSchedule, nhlScores, nflSchedule, nflScores] = await Promise.all([
                        fetchWithFallback(nbaScheduleProxy, nbaScheduleDirect),
                        fetchWithFallback(nbaScoresProxy, nbaScoresDirect),
                        fetchWithFallback(nhlScheduleProxy, nhlScheduleDirect),
                        fetchWithFallback(nhlScoresProxy, nhlScoresDirect),
                        fetchWithFallback(nflScheduleProxy, nflScheduleDirect),
                        fetchWithFallback(nflScoresProxy, nflScoresDirect)
                    ]);
                    
                    // Combine NBA, NHL, and NFL data
                    // Explicitly set league on each game to ensure it's preserved
                    const nbaGames = (nbaSchedule.games || []).map(g => ({...g, league: 'nba', sport: 'nba'}));
                    const nhlGames = (nhlSchedule.games || []).map(g => ({...g, league: 'nhl', sport: 'nhl'}));
                    const nflGames = (nflSchedule.games || []).map(g => ({...g, league: 'nfl', sport: 'nfl'}));
                    
                    scheduleData = {
                        date: nbaSchedule.date || nhlSchedule.date || nflSchedule.date,
                        games: [...nbaGames, ...nhlGames, ...nflGames]
                    };
                    
                    const nbaScoresList = (nbaScores.scores || []).map(g => ({...g, league: 'nba', sport: 'nba'}));
                    const nhlScoresList = (nhlScores.scores || []).map(g => ({...g, league: 'nhl', sport: 'nhl'}));
                    const nflScoresList = (nflScores.scores || []).map(g => ({...g, league: 'nfl', sport: 'nfl'}));
                    
                    scoresData = {
                        date: nbaScores.date || nhlScores.date || nflScores.date,
                        scores: [...nbaScoresList, ...nhlScoresList, ...nflScoresList]
                    };
                    
                    // Debug logging for NFL
                    console.log('NFL Schedule games:', nflGames.length);
                    console.log('NFL Scores games:', nflScoresList.length);
                    console.log('Total games by league:', {
                        nba: nbaGames.length,
                        nhl: nhlGames.length,
                        nfl: nflGames.length
                    });
                } else {
                    // For single league
                    const scheduleProxy = proxyScheduleUrl.replace(/\/nba\//, `/${league}/`) + `?tz=${timezone}`;
                    const scoresProxy = proxyScoresUrl.replace(/\/nba\//, `/${league}/`) + `?tz=${timezone}`;
                    const scheduleDirect = `${API_BASE}/schedule/${league}/today?tz=${timezone}`;
                    const scoresDirect = `${API_BASE}/scores/${league}/today?tz=${timezone}`;
                    
                    [scheduleData, scoresData] = await Promise.all([
                        fetchWithFallback(scheduleProxy, scheduleDirect),
                        fetchWithFallback(scoresProxy, scoresDirect)
                    ]);
                    
                    // Ensure league is set on all games for single league mode
                    if (scheduleData.games) {
                        scheduleData.games = scheduleData.games.map(g => ({...g, league: league, sport: league}));
                    }
                    if (scoresData.scores) {
                        scoresData.scores = scoresData.scores.map(g => ({...g, league: league, sport: league}));
                    }
                }
                
                // Debug logging
                console.log('Schedule data:', scheduleData);
                console.log('Scores data:', scoresData);
                console.log('Available team colors:', allTeamColors ? Object.keys(allTeamColors) : 'undefined');
                
                // Validate allTeamColors structure
                if (!allTeamColors || typeof allTeamColors !== 'object') {
                    console.error('allTeamColors is not properly initialized:', allTeamColors);
                    allTeamColors = {};
                }
                
                // Get team colors - if "all", merge all leagues; otherwise get specific league
                let teamColors = {};
                if (league === 'all') {
                    // Merge all team colors from all leagues
                    Object.values(allTeamColors).forEach(leagueColors => {
                        if (leagueColors && typeof leagueColors === 'object' && !Array.isArray(leagueColors)) {
                            Object.assign(teamColors, leagueColors);
                        }
                    });
                } else {
                    teamColors = (allTeamColors[leagueUpper] && typeof allTeamColors[leagueUpper] === 'object' && !Array.isArray(allTeamColors[leagueUpper])) 
                        ? allTeamColors[leagueUpper] 
                        : {};
                }
                
                console.log(`Team colors for ${leagueUpper}:`, Object.keys(teamColors).length, 'teams');
                // Debug: Show sample team names for each league when "all" is selected
                if (league === 'all') {
                    console.log('Team colors structure (by league):', Object.keys(allTeamColors));
                    Object.keys(allTeamColors).forEach(leagueKey => {
                        if (allTeamColors[leagueKey] && typeof allTeamColors[leagueKey] === 'object') {
                            const leagueTeams = Object.keys(allTeamColors[leagueKey]);
                            console.log(`${leagueKey} teams (${leagueTeams.length}):`, leagueTeams.slice(0, 5));
                        }
                    });
                }
                if (Object.keys(teamColors).length > 0) {
                    console.log('Sample team names in colors:', Object.keys(teamColors).slice(0, 5));
                } else {
                    console.warn(`No team colors found for ${leagueUpper}. Available leagues:`, Object.keys(allTeamColors));
                }
                
                // Check for API errors
                if (scheduleData.error || scoresData.error) {
                    throw new Error(scheduleData.error || scoresData.error);
                }
                
                // Check if we have games data
                if (!scheduleData.games && !scoresData.scores) {
                    console.warn('No games found in API response');
                } else {
                    console.log('Games found - Schedule:', scheduleData.games?.length || 0, 'Scores:', scoresData.scores?.length || 0);
                }
                
                // Helper function to find team data with fuzzy matching
                function findTeamData(teamName) {
                    if (!teamName || !teamColors || Object.keys(teamColors).length === 0) {
                        return null;
                    }
                    
                    const searchName = teamName.trim();
                    
                    // Try exact match first
                    if (teamColors[searchName]) {
                        return teamColors[searchName];
                    }
                    
                    // Try case-insensitive exact match
                    for (const key in teamColors) {
                        if (key.toLowerCase() === searchName.toLowerCase()) {
                            return teamColors[key];
                        }
                    }
                    
                    // Try matching by last word (team name like "Patriots", "Chiefs")
                    const nameParts = searchName.split(' ').filter(p => p.length > 0);
                    if (nameParts.length > 0) {
                        const lastWord = nameParts[nameParts.length - 1].toLowerCase();
                        
                        // First try last two words (e.g., "Kansas City Chiefs" -> "City Chiefs")
                        if (nameParts.length >= 2) {
                            const lastTwo = nameParts.slice(-2).join(' ').toLowerCase();
                            for (const key in teamColors) {
                                const keyLower = key.toLowerCase();
                                if (keyLower === lastTwo || keyLower.endsWith(' ' + lastTwo)) {
                                    return teamColors[key];
                                }
                            }
                        }
                        
                        // Then try last word only
                        for (const key in teamColors) {
                            const keyParts = key.split(' ').filter(p => p.length > 0);
                            if (keyParts.length > 0 && keyParts[keyParts.length - 1].toLowerCase() === lastWord) {
                                return teamColors[key];
                            }
                        }
                    }
                    
                    // Try removing common prefixes and matching
                    const prefixesToRemove = ['the ', 'new ', 'san ', 'los ', 'las ', 'de ', 'la '];
                    let cleanedName = searchName.toLowerCase();
                    for (const prefix of prefixesToRemove) {
                        if (cleanedName.startsWith(prefix)) {
                            cleanedName = cleanedName.substring(prefix.length);
                            break;
                        }
                    }
                    
                    for (const key in teamColors) {
                        let keyCleaned = key.toLowerCase();
                        for (const prefix of prefixesToRemove) {
                            if (keyCleaned.startsWith(prefix)) {
                                keyCleaned = keyCleaned.substring(prefix.length);
                                break;
                            }
                        }
                        if (keyCleaned === cleanedName || keyCleaned.includes(cleanedName) || cleanedName.includes(keyCleaned)) {
                            return teamColors[key];
                        }
                    }
                    
                    // NFL-specific: Try matching abbreviations and common variations
                    // Check if this might be an NFL team by looking for common NFL patterns
                    const nflAbbrevs = ['ARI', 'ATL', 'BAL', 'BUF', 'CAR', 'CHI', 'CIN', 'CLE', 'DAL', 'DEN', 'DET', 
                                      'GB', 'HOU', 'IND', 'JAX', 'KC', 'LV', 'LAC', 'LAR', 'MIA', 'MIN', 'NE', 'NO', 
                                      'NYG', 'NYJ', 'PHI', 'PIT', 'SF', 'SEA', 'TB', 'TEN', 'WSH', 'WAS'];
                    if (nflAbbrevs.includes(searchName.toUpperCase())) {
                        // Try to find by abbreviation (should be mapped in backend)
                        const abbrevKey = searchName.toUpperCase();
                        if (teamColors[abbrevKey]) {
                            return teamColors[abbrevKey];
                        }
                    }
                    
                    // Try matching just the team name part (e.g., "Eagles", "Patriots", "Chiefs")
                    // This is useful when API returns just the team name without city
                    const teamNameOnly = searchName.split(' ').pop();
                    if (teamNameOnly && teamNameOnly.length > 2) {
                        for (const key in teamColors) {
                            const keyParts = key.split(' ');
                            if (keyParts.length > 0) {
                                const keyTeamName = keyParts[keyParts.length - 1].toLowerCase();
                                if (keyTeamName === teamNameOnly.toLowerCase()) {
                                    return teamColors[key];
                                }
                            }
                        }
                    }
                    
                    // Log when team not found for debugging
                    console.warn(`Team not found: "${teamName}". Available teams (first 20):`, Object.keys(teamColors).slice(0, 20));
                    console.warn(`Searching for: "${searchName}", cleaned: "${cleanedName}"`);
                    
                    return null;
                }
                
                // Helper function to get team color
                function getTeamColor(teamName) {
                    const team = findTeamData(teamName);
                    return team ? (team.color_1 || '#6c757d') : '#6c757d';
                }
                
                // Helper function to get team logo
                function getTeamLogo(teamName) {
                    const team = findTeamData(teamName);
                    return team ? (team.logo_url || '/static/images/no-logo.png') : '/static/images/no-logo.png';
                }
                
                // Helper function to get team logo background
                function getTeamLogoBg(teamName) {
                    const team = findTeamData(teamName);
                    return team ? (team.color_3 || '#FFFFFF') : '#FFFFFF';
                }
                
                // Helper function to get team color 2 (secondary color)
                function getTeamColor2(teamName) {
                    const team = findTeamData(teamName);
                    return team ? (team.color_2 || '#FFFFFF') : '#FFFFFF';
                }
                
                // Helper function to get team color 3 (tertiary color)
                function getTeamColor3(teamName) {
                    const team = findTeamData(teamName);
                    return team ? (team.color_3 || '#000000') : '#000000';
                }
                
                // Helper function to check contrast ratio (WCAG AA minimum is 4.5:1)
                function getContrastRatio(color1, color2) {
                    function hexToRgb(hex) {
                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                        return result ? {
                            r: parseInt(result[1], 16),
                            g: parseInt(result[2], 16),
                            b: parseInt(result[3], 16)
                        } : null;
                    }
                    
                    function getLuminance(r, g, b) {
                        const [rs, gs, bs] = [r, g, b].map(c => {
                            c = c / 255;
                            return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                        });
                        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
                    }
                    
                    const rgb1 = hexToRgb(color1);
                    const rgb2 = hexToRgb(color2);
                    
                    if (!rgb1 || !rgb2) return 1;
                    
                    const lum1 = getLuminance(rgb1.r, rgb1.g, rgb1.b);
                    const lum2 = getLuminance(rgb2.r, rgb2.g, rgb2.b);
                    
                    const brightest = Math.max(lum1, lum2);
                    const darkest = Math.min(lum1, lum2);
                    
                    return (brightest + 0.05) / (darkest + 0.05);
                }
                
                // Helper function to get optimal text color for abbreviation box
                function getAbbrevBoxColors(teamName, bgColor, textColor) {
                    const minContrast = 4.5; // WCAG AA standard
                    const contrast = getContrastRatio(bgColor, textColor);
                    
                    if (contrast >= minContrast) {
                        return { bg: bgColor, text: textColor };
                    }
                    
                    // If contrast is insufficient, try white or black text
                    const whiteContrast = getContrastRatio(bgColor, '#FFFFFF');
                    const blackContrast = getContrastRatio(bgColor, '#000000');
                    
                    if (whiteContrast >= minContrast && whiteContrast > blackContrast) {
                        return { bg: bgColor, text: '#FFFFFF' };
                    } else if (blackContrast >= minContrast) {
                        return { bg: bgColor, text: '#000000' };
                    } else {
                        // If still insufficient, adjust background to be lighter/darker
                        // Try a lighter version of the background
                        const team = findTeamData(teamName);
                        const primaryColor = team ? (team.color_1 || '#6c757d') : '#6c757d';
                        const primaryContrast = getContrastRatio(primaryColor, '#FFFFFF');
                        if (primaryContrast >= minContrast) {
                            return { bg: primaryColor, text: '#FFFFFF' };
                        } else {
                            return { bg: bgColor, text: '#000000' }; // Fallback
                        }
                    }
                }
                
                // Helper function to get team URL
                function getTeamUrl(teamName, league = 'NBA') {
                    const teamNameUrl = teamName.replace(/\s+/g, '_');
                    return `/team/${league}/${teamNameUrl}`;
                }
                
                // Helper function to get text color (light or dark based on background)
                function getTextColor(bgColor) {
                    if (!bgColor || bgColor === '#6c757d') return '#ffffff';
                    const hex = bgColor.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                    return brightness > 155 ? '#000000' : '#ffffff';
                }
                
                // Helper function to render a game row
                function renderGameRow(game, teamColors, gameLeague) {
                    const hasScore = game.home_score !== undefined && game.visitor_score !== undefined;
                    const isFinal = game.is_final || game.game_status === 'final';
                    const isScheduled = game.game_status === 'scheduled';
                    
                    // Get team colors and logos
                    // Debug logging for NFL teams
                    if (gameLeague === 'NFL') {
                        console.log(`\n=== NFL Game Debug ===`);
                        console.log(`Game: ${game.visitor_team} @ ${game.home_team}`);
                        console.log(`Total teams in teamColors:`, Object.keys(teamColors).length);
                        console.log(`NFL teams available:`, Object.keys(teamColors).filter(k => {
                            const team = teamColors[k];
                            return team && (team.logo_url && team.logo_url.includes('/nfl/'));
                        }).slice(0, 10));
                        console.log(`Looking for visitor: "${game.visitor_team}"`);
                        const visitorTeam = findTeamData(game.visitor_team);
                        console.log(`Visitor team found:`, visitorTeam ? 'YES' : 'NO', visitorTeam);
                        console.log(`Looking for home: "${game.home_team}"`);
                        const homeTeam = findTeamData(game.home_team);
                        console.log(`Home team found:`, homeTeam ? 'YES' : 'NO', homeTeam);
                        console.log(`=== End NFL Debug ===\n`);
                    }
                    const visitorColor = getTeamColor(game.visitor_team);
                    const homeColor = getTeamColor(game.home_team);
                    const visitorTextColor = getTextColor(visitorColor);
                    const homeTextColor = getTextColor(homeColor);
                    const visitorLogo = getTeamLogo(game.visitor_team);
                    const homeLogo = getTeamLogo(game.home_team);
                    const visitorLogoBg = getTeamLogoBg(game.visitor_team);
                    const homeLogoBg = getTeamLogoBg(game.home_team);
                    
                    // Determine winner
                    let visitorIsWinner = false;
                    let homeIsWinner = false;
                    if (hasScore && isFinal) {
                        visitorIsWinner = game.visitor_score > game.home_score;
                        homeIsWinner = game.home_score > game.visitor_score;
                    }
                    
                    // Helper to get short team name
                    function getShortTeamName(teamName) {
                        const cityMap = {
                            'Los Angeles': 'LA',
                            'San Francisco': 'SF',
                            'New York': 'NY',
                            'New Jersey': 'NJ',
                            'Golden State': 'GS',
                            'Oklahoma City': 'OKC',
                            'Portland': 'POR'
                        };
                        let shortName = teamName;
                        for (const [city, abbrev] of Object.entries(cityMap)) {
                            if (shortName.startsWith(city + ' ')) {
                                shortName = shortName.replace(city, abbrev);
                                break;
                            }
                        }
                        const parts = shortName.split(' ');
                        if (parts.length > 2 && shortName.length > 15) {
                            return parts.slice(-2).join(' ');
                        }
                        return shortName;
                    }
                    const visitorShortName = getShortTeamName(game.visitor_team);
                    const homeShortName = getShortTeamName(game.home_team);
                    
                    // Format status
                    let statusDisplay = '';
                    if (isFinal) {
                        const period = parseInt(game.current_period) || 4;
                        if (period > 4) {
                            const otCount = period - 4;
                            statusDisplay = otCount === 1 ? 'F/OT' : `F/${otCount}OT`;
                        } else {
                            statusDisplay = 'F';
                        }
                    } else if (game.current_period && game.time_remaining) {
                        const period = parseInt(game.current_period);
                        // Use P for Period in NHL, Q for Quarter in NBA
                        const periodPrefix = gameLeague === 'NHL' ? 'P' : 'Q';
                        let periodDisplay = period > 4 ? (period - 4 === 1 ? 'OT' : `${period - 4}OT`) : `${periodPrefix}${period}`;
                        statusDisplay = `${periodDisplay} - ${game.time_remaining}`;
                    } else if (isScheduled && game.game_time) {
                        const gameDate = new Date(game.game_time);
                        const now = new Date();
                        const diffMs = gameDate - now;
                        const gameTimeStr = gameDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', timeZoneName: 'short' });
                        if (diffMs > 0) {
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            const timeUntilStr = diffHours > 0 ? `${diffHours}h${diffMins}m` : `${diffMins}m`;
                            statusDisplay = `${gameTimeStr} - in ${timeUntilStr}`;
                        } else {
                            statusDisplay = `${gameTimeStr} - Scheduled`;
                        }
                    } else {
                        statusDisplay = 'Scheduled';
                    }
                    
                    // Get team records - W-L-OTL for NHL, W-L for other leagues
                    let visitorRecord = '';
                    let homeRecord = '';
                    if (gameLeague === 'NHL') {
                        // NHL format: W-L-OTL
                        // API uses home_otl/visitor_otl (not home_overtime_losses)
                        const visitorOTL = game.visitor_otl !== undefined && game.visitor_otl !== null 
                            ? game.visitor_otl 
                            : (game.visitor_overtime_losses !== undefined && game.visitor_overtime_losses !== null ? game.visitor_overtime_losses : 0);
                        const homeOTL = game.home_otl !== undefined && game.home_otl !== null 
                            ? game.home_otl 
                            : (game.home_overtime_losses !== undefined && game.home_overtime_losses !== null ? game.home_overtime_losses : 0);
                        
                        // Debug logging for NHL games
                        if (game.visitor_team && game.home_team) {
                            console.log(`NHL Game ${game.visitor_team} @ ${game.home_team}:`, {
                                visitor_wins: game.visitor_wins,
                                visitor_losses: game.visitor_losses,
                                visitor_overtime_losses: game.visitor_overtime_losses,
                                visitor_otl: game.visitor_otl,
                                home_wins: game.home_wins,
                                home_losses: game.home_losses,
                                home_overtime_losses: game.home_overtime_losses,
                                home_otl: game.home_otl,
                                full_game: game
                            });
                        }
                        
                        if (game.visitor_wins !== undefined && game.visitor_losses !== undefined) {
                            visitorRecord = `${game.visitor_wins}-${game.visitor_losses}-${visitorOTL}`;
                        }
                        if (game.home_wins !== undefined && game.home_losses !== undefined) {
                            homeRecord = `${game.home_wins}-${game.home_losses}-${homeOTL}`;
                        }
                    } else {
                        // Other leagues: W-L
                        visitorRecord = (game.visitor_wins !== undefined && game.visitor_losses !== undefined) 
                            ? `${game.visitor_wins}-${game.visitor_losses}` : '';
                        homeRecord = (game.home_wins !== undefined && game.home_losses !== undefined) 
                            ? `${game.home_wins}-${game.home_losses}` : '';
                    }
                    
                    // Format score
                    let scoreDisplay = '-';
                    if (hasScore) {
                        if (isFinal) {
                            if (visitorIsWinner) {
                                scoreDisplay = `<span class="winner-score">${game.visitor_score}</span> - <span>${game.home_score}</span>`;
                            } else if (homeIsWinner) {
                                scoreDisplay = `<span>${game.visitor_score}</span> - <span class="winner-score">${game.home_score}</span>`;
                            } else {
                                scoreDisplay = `${game.visitor_score} - ${game.home_score}`;
                            }
                        } else {
                            scoreDisplay = `${game.visitor_score} - ${game.home_score}`;
                        }
                    }
                    
                    const visitorUrl = getTeamUrl(game.visitor_team, gameLeague);
                    const homeUrl = getTeamUrl(game.home_team, gameLeague);
                    
                    // Get team abbreviations
                    const visitorAbbrev = game.visitor_team_abbrev || '';
                    const homeAbbrev = game.home_team_abbrev || '';
                    
                    // Get abbreviation box colors with contrast checking
                    const visitorAbbrevBg = getTeamColor2(game.visitor_team);
                    const visitorAbbrevText = getTeamColor3(game.visitor_team);
                    const visitorAbbrevColors = getAbbrevBoxColors(game.visitor_team, visitorAbbrevBg, visitorAbbrevText);
                    
                    const homeAbbrevBg = getTeamColor2(game.home_team);
                    const homeAbbrevText = getTeamColor3(game.home_team);
                    const homeAbbrevColors = getAbbrevBoxColors(game.home_team, homeAbbrevBg, homeAbbrevText);
                    
                    return `
                        <tr>
                            <td style="background-color: ${visitorColor}; color: ${visitorTextColor}; padding: 10px 8px; font-weight: 600; border-radius: 4px 0 0 4px; position: relative; white-space: nowrap;">
                                <a href="${visitorUrl}" style="text-decoration: none; color: inherit; display: flex; align-items-center; gap: 6px;" class="team-link">
                                    <div style="position: relative; flex-shrink: 0;">
                                        <img src="${visitorLogo}" alt="${game.visitor_team}" style="width: 28px; height: 28px; object-fit: contain; background-color: ${visitorLogoBg}; padding: 2px; border-radius: 4px;" onerror="this.style.display='none';">
                                        ${visitorIsWinner ? `<img src="/static/images/winner-star.png" alt="Winner" class="winner-star-large" />` : ''}
                                    </div>
                                    ${visitorAbbrev ? `<span class="team-abbrev-box" style="font-size: 0.7rem; font-weight: 700; padding: 2px 4px; background-color: ${visitorAbbrevColors.bg}; color: ${visitorAbbrevColors.text}; border-radius: 3px; margin-right: 4px; min-width: 28px; text-align: center; display: inline-block;">${visitorAbbrev}</span>` : ''}
                                    <span class="team-name-text" style="flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem;" title="${game.visitor_team}">${visitorShortName}</span>
                                    ${visitorRecord ? `<span class="team-record" style="font-size: 0.75rem; opacity: 0.9;">(${visitorRecord})</span>` : ''}
                                </a>
                            </td>
                            <td style="text-align: center; font-weight: 700; font-size: 1.3rem; padding: 10px 8px; position: relative; white-space: nowrap; min-width: 80px;">
                                ${scoreDisplay}
                            </td>
                            <td style="background-color: ${homeColor}; color: ${homeTextColor}; padding: 10px 8px; font-weight: 600; border-radius: 0 4px 4px 0; position: relative; white-space: nowrap;">
                                <a href="${homeUrl}" style="text-decoration: none; color: inherit; display: flex; align-items-center; gap: 6px;" class="team-link">
                                    <div style="position: relative; flex-shrink: 0;">
                                        <img src="${homeLogo}" alt="${game.home_team}" style="width: 28px; height: 28px; object-fit: contain; background-color: ${homeLogoBg}; padding: 2px; border-radius: 4px;" onerror="this.style.display='none';">
                                        ${homeIsWinner ? `<img src="/static/images/winner-star.png" alt="Winner" class="winner-star-large" />` : ''}
                                    </div>
                                    ${homeAbbrev ? `<span class="team-abbrev-box" style="font-size: 0.7rem; font-weight: 700; padding: 2px 4px; background-color: ${homeAbbrevColors.bg}; color: ${homeAbbrevColors.text}; border-radius: 3px; margin-right: 4px; min-width: 28px; text-align: center; display: inline-block;">${homeAbbrev}</span>` : ''}
                                    <span class="team-name-text" style="flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.9rem;" title="${game.home_team}">${homeShortName}</span>
                                    ${homeRecord ? `<span class="team-record" style="font-size: 0.75rem; opacity: 0.9;">(${homeRecord})</span>` : ''}
                                </a>
                            </td>
                            <td style="text-align: center; padding: 10px 8px; white-space: nowrap; font-size: 0.85rem;">
                                ${statusDisplay}
                            </td>
                        </tr>
                    `;
                }
                
                // Create a map of game_id to scores for quick lookup
                const scoresMap = {};
                if (scoresData.scores) {
                    scoresData.scores.forEach(game => {
                        scoresMap[game.game_id] = game;
                    });
                }
                
                // Create a map of all games by game_id (from both schedule and scores)
                const allGamesMap = {};
                
                // Add games from schedule
                if (scheduleData.games) {
                    scheduleData.games.forEach(game => {
                        const scoreData = scoresMap[game.game_id];
                        // Preserve league from game (set when combining data from multiple leagues)
                        // Ensure league is always set - it should be set when combining data
                        let gameLeague = game.league || game.sport;
                        if (!gameLeague && league !== 'all') {
                            gameLeague = league;
                        } else if (!gameLeague) {
                            // Last resort - this shouldn't happen if data combining worked correctly
                            gameLeague = 'nba'; // Default fallback
                        }
                        allGamesMap[game.game_id] = {
                            ...game,
                            league: gameLeague, // Explicitly preserve league
                            sport: gameLeague, // Also set sport for compatibility
                            home_score: scoreData?.home_score,
                            visitor_score: scoreData?.visitor_score,
                            is_final: scoreData?.is_final,
                            game_status: scoreData?.game_status || game.game_status,
                            current_period: scoreData?.current_period,
                            time_remaining: scoreData?.time_remaining,
                            // Use OTL from scores if available, otherwise from schedule
                            // API uses home_otl/visitor_otl (not home_overtime_losses)
                            home_wins: scoreData?.home_wins !== undefined ? scoreData.home_wins : game.home_wins,
                            home_losses: scoreData?.home_losses !== undefined ? scoreData.home_losses : game.home_losses,
                            visitor_wins: scoreData?.visitor_wins !== undefined ? scoreData.visitor_wins : game.visitor_wins,
                            visitor_losses: scoreData?.visitor_losses !== undefined ? scoreData.visitor_losses : game.visitor_losses,
                            home_otl: scoreData?.home_otl !== undefined && scoreData?.home_otl !== null 
                                ? scoreData.home_otl 
                                : (game.home_otl !== undefined && game.home_otl !== null ? game.home_otl : 0),
                            visitor_otl: scoreData?.visitor_otl !== undefined && scoreData?.visitor_otl !== null 
                                ? scoreData.visitor_otl 
                                : (game.visitor_otl !== undefined && game.visitor_otl !== null ? game.visitor_otl : 0),
                            // Also keep old field names for backward compatibility
                            home_overtime_losses: scoreData?.home_otl !== undefined && scoreData?.home_otl !== null 
                                ? scoreData.home_otl 
                                : (game.home_otl !== undefined && game.home_otl !== null ? game.home_otl : 0),
                            visitor_overtime_losses: scoreData?.visitor_otl !== undefined && scoreData?.visitor_otl !== null 
                                ? scoreData.visitor_otl 
                                : (game.visitor_otl !== undefined && game.visitor_otl !== null ? game.visitor_otl : 0),
                            home_team_abbrev: game.home_team_abbrev || game.home_team?.split(' ').pop()?.substring(0, 3).toUpperCase() || '',
                            visitor_team_abbrev: game.visitor_team_abbrev || game.visitor_team?.split(' ').pop()?.substring(0, 3).toUpperCase() || ''
                        };
                    });
                }
                
                // Add games from scores that might not be in schedule (TBD games)
                if (scoresData.scores) {
                    scoresData.scores.forEach(scoreGame => {
                        if (!allGamesMap[scoreGame.game_id]) {
                            // Game exists in scores but not in schedule - add it
                            // Determine league from scoreGame data - try multiple sources
                            let scoreLeague = scoreGame.league || scoreGame.sport;
                            // If still not found and we're in "all" mode, try to infer from team names or API source
                            if (!scoreLeague && league === 'all') {
                                // Try to infer from which scoresData object this came from
                                // This is a fallback - the league should be set when combining data
                                scoreLeague = 'nba'; // Default fallback, but this shouldn't happen
                            } else if (!scoreLeague) {
                                scoreLeague = league; // Use the selected league
                            }
                            allGamesMap[scoreGame.game_id] = {
                                game_id: scoreGame.game_id,
                                league: scoreLeague, // Preserve league
                                sport: scoreLeague, // Also set sport
                                game_date: scoresData.date,
                                game_time: null,
                                home_team: scoreGame.home_team,
                                home_team_abbrev: scoreGame.home_team_abbrev || scoreGame.home_team.split(' ').pop().substring(0, 3).toUpperCase(),
                                visitor_team: scoreGame.visitor_team,
                                visitor_team_abbrev: scoreGame.visitor_team_abbrev || scoreGame.visitor_team.split(' ').pop().substring(0, 3).toUpperCase(),
                                game_status: scoreGame.game_status,
                                game_type: 'regular',
                                home_score: scoreGame.home_score,
                                visitor_score: scoreGame.visitor_score,
                                is_final: scoreGame.is_final,
                                current_period: scoreGame.current_period,
                                time_remaining: scoreGame.time_remaining,
                                home_wins: null,
                                home_losses: null,
                                visitor_wins: null,
                                visitor_losses: null,
                                home_otl: scoreGame.home_otl !== undefined && scoreGame.home_otl !== null ? scoreGame.home_otl : null,
                                visitor_otl: scoreGame.visitor_otl !== undefined && scoreGame.visitor_otl !== null ? scoreGame.visitor_otl : null,
                                // Also keep old field names for backward compatibility
                                home_overtime_losses: scoreGame.home_otl !== undefined && scoreGame.home_otl !== null ? scoreGame.home_otl : null,
                                visitor_overtime_losses: scoreGame.visitor_otl !== undefined && scoreGame.visitor_otl !== null ? scoreGame.visitor_otl : null
                            };
                        } else {
                            // Update existing game with latest score data
                            const existing = allGamesMap[scoreGame.game_id];
                            // Preserve league - don't overwrite if already set, but set if missing
                            if (!existing.league) {
                                existing.league = scoreGame.league || scoreGame.sport || (league !== 'all' ? league : 'nba');
                                existing.sport = existing.league;
                            } else if (scoreGame.league && !existing.league) {
                                // If existing doesn't have league but scoreGame does, use it
                                existing.league = scoreGame.league;
                                existing.sport = scoreGame.league;
                            }
                            existing.home_score = scoreGame.home_score;
                            existing.visitor_score = scoreGame.visitor_score;
                            existing.is_final = scoreGame.is_final;
                            existing.game_status = scoreGame.game_status;
                            existing.current_period = scoreGame.current_period;
                            existing.time_remaining = scoreGame.time_remaining;
                            // Update wins/losses from scores if available
                            if (scoreGame.home_wins !== undefined) {
                                existing.home_wins = scoreGame.home_wins;
                            }
                            if (scoreGame.home_losses !== undefined) {
                                existing.home_losses = scoreGame.home_losses;
                            }
                            if (scoreGame.visitor_wins !== undefined) {
                                existing.visitor_wins = scoreGame.visitor_wins;
                            }
                            if (scoreGame.visitor_losses !== undefined) {
                                existing.visitor_losses = scoreGame.visitor_losses;
                            }
                            // Update OTL from scores - API uses home_otl/visitor_otl
                            if (scoreGame.home_otl !== undefined && scoreGame.home_otl !== null) {
                                existing.home_otl = scoreGame.home_otl;
                                existing.home_overtime_losses = scoreGame.home_otl; // Also set for backward compatibility
                            }
                            if (scoreGame.visitor_otl !== undefined && scoreGame.visitor_otl !== null) {
                                existing.visitor_otl = scoreGame.visitor_otl;
                                existing.visitor_overtime_losses = scoreGame.visitor_otl; // Also set for backward compatibility
                            }
                        }
                    });
                }
                
                // Convert map to array and sort by game_time (scheduled games first, then TBD)
                const games = Object.values(allGamesMap).sort((a, b) => {
                    if (a.game_time && b.game_time) {
                        return new Date(a.game_time) - new Date(b.game_time);
                    }
                    if (a.game_time) return -1;
                    if (b.game_time) return 1;
                    return 0;
                });
                
                if (games.length === 0) {
                    container.innerHTML = `
                        <div class="text-center">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No games scheduled for today.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Group games by league if "all" is selected
                // Note: API response for "all" may have different structure
                let gamesByLeague = {};
                if (league === 'all') {
                    // Check if API returned games grouped by sport/league
                    if (scheduleData.sports || scheduleData.leagues) {
                        // API returns grouped data
                        const sportsData = scheduleData.sports || scheduleData.leagues || {};
                        Object.keys(sportsData).forEach(sportKey => {
                            const sportGames = sportsData[sportKey].games || [];
                            sportGames.forEach(game => {
                                if (!gamesByLeague[sportKey.toUpperCase()]) {
                                    gamesByLeague[sportKey.toUpperCase()] = [];
                                }
                                gamesByLeague[sportKey.toUpperCase()].push(game);
                            });
                        });
                    } else {
                        // Flat list - try to determine league from game data
                        games.forEach(game => {
                            // Try multiple ways to determine league
                            let gameLeague = game.league || game.sport;
                            // If still not found, try to infer from team names or other data
                            if (!gameLeague) {
                                // Try to infer from team names or use the selected league
                                if (league !== 'all') {
                                    gameLeague = league;
                                } else {
                                    // Last resort - try to infer from team data
                                    const visitorTeam = findTeamData(game.visitor_team);
                                    if (visitorTeam && visitorTeam.league) {
                                        gameLeague = visitorTeam.league.toLowerCase();
                                    } else {
                                        gameLeague = 'nba'; // Default fallback
                                    }
                                }
                            }
                            gameLeague = gameLeague.toUpperCase();
                            if (!gamesByLeague[gameLeague]) {
                                gamesByLeague[gameLeague] = [];
                            }
                            // Ensure league is set on the game object
                            if (!game.league) {
                                game.league = gameLeague.toLowerCase();
                            }
                            if (!game.sport) {
                                game.sport = gameLeague.toLowerCase();
                            }
                            gamesByLeague[gameLeague].push(game);
                        });
                    }
                }
                
                // Render games in table format with team colors
                let html = '';
                
                if (league === 'all') {
                    // Render grouped by league
                    const leagueOrder = ['NBA', 'NHL', 'MLB', 'NFL', 'WNBA', 'MLS'];
                    Object.keys(gamesByLeague).sort((a, b) => {
                        const aIdx = leagueOrder.indexOf(a.toUpperCase());
                        const bIdx = leagueOrder.indexOf(b.toUpperCase());
                        if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
                        if (aIdx === -1) return 1;
                        if (bIdx === -1) return -1;
                        return aIdx - bIdx;
                    }).forEach(leagueName => {
                        const leagueGames = gamesByLeague[leagueName];
                        const leagueUpper = leagueName.toUpperCase();
                        const leagueLogo = leagueUpper === 'NBA' ? '{{ "NBA" | get_league_logo }}' : 
                                          leagueUpper === 'NHL' ? '{{ "NHL" | get_league_logo }}' :
                                          leagueUpper === 'MLB' ? '{{ "MLB" | get_league_logo }}' :
                                          leagueUpper === 'NFL' ? '{{ "NFL" | get_league_logo }}' :
                                          leagueUpper === 'WNBA' ? '{{ "WNBA" | get_league_logo }}' :
                                          leagueUpper === 'MLS' ? '{{ "MLS" | get_league_logo }}' : '';
                        
                        html += `
                            <div class="league-section mb-4">
                                <div class="league-header mb-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        ${leagueLogo ? `<img src="${leagueLogo}" alt="${leagueUpper}" style="height: 50px; vertical-align: middle; margin-right: 10px;" onerror="this.style.display='none';">` : ''}
                                        <span style="font-size: 1.3rem; font-weight: 600; color: #2D1B4E;">${leagueUpper}</span>
                                    </div>
                                </div>
                                <div class="table-responsive-scores">
                                    <table class="table table-hover align-middle mb-0 scores-table" style="table-layout: auto; width: 100%;">
                                        <thead>
                                            <tr>
                                                <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Visitor</th>
                                                <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Score</th>
                                                <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Home</th>
                                                <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                        `;
                        
                        // Render games for this league
                        leagueGames.forEach(game => {
                            // Ensure game has league set
                            const gameLeague = (game.league || game.sport || leagueUpper).toUpperCase();
                            if (!game.league) game.league = gameLeague.toLowerCase();
                            if (!game.sport) game.sport = gameLeague.toLowerCase();
                            
                            // For "all" view, we need to get team colors specific to this league
                            // since teamColors is merged from all leagues
                            // The merged teamColors should already have all teams, so we can use it as-is
                            html += renderGameRow(game, teamColors, gameLeague);
                        });
                        
                        html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Render single league
                    const leagueLogo = leagueUpper === 'NBA' ? '{{ "NBA" | get_league_logo }}' : 
                                      leagueUpper === 'NHL' ? '{{ "NHL" | get_league_logo }}' :
                                      leagueUpper === 'NFL' ? '{{ "NFL" | get_league_logo }}' :
                                      '{{ "NBA" | get_league_logo }}';
                    html = `
                        <div class="league-header mb-3">
                            <div class="d-flex align-items-center justify-content-center">
                                <img src="${leagueLogo}" alt="${leagueUpper}" style="height: 60px; vertical-align: middle; margin-right: 10px;" onerror="this.style.display='none';">
                                <span style="font-size: 1.5rem; font-weight: 600; color: #2D1B4E;">${leagueUpper}</span>
                            </div>
                        </div>
                        <div class="table-responsive-scores">
                            <table class="table table-hover align-middle mb-0 scores-table" style="table-layout: auto; width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Visitor</th>
                                        <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Score</th>
                                        <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Home</th>
                                        <th style="text-align: center; white-space: nowrap; padding: 12px 8px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    games.forEach(game => {
                        html += renderGameRow(game, teamColors, leagueUpper);
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading scores and schedules:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    league: league,
                    timezone: timezone
                });
                container.innerHTML = `
                    <div class="text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to load scores and schedules. Error: ${error.message}
                            <br><small>Please check the console for more details.</small>
                        </div>
                    </div>
                `;
            }
        }
        
        // Load on page load and when dropdowns change
        document.addEventListener('DOMContentLoaded', function() {
            loadScoresAndSchedules();
            
            // Reload when league or timezone changes
            document.getElementById('league-select').addEventListener('change', loadScoresAndSchedules);
            document.getElementById('timezone-select').addEventListener('change', loadScoresAndSchedules);
            
            // Auto-refresh every 60 seconds if page is visible
            setInterval(() => {
                if (!document.hidden) {
                    loadScoresAndSchedules();
                }
            }, 60000);
        });
    </script>
    <style>
        #scores-schedules-container {
            background: linear-gradient(135deg, #6A5ACD 0%, #9370DB 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(106, 90, 205, 0.3);
            margin: 0 auto;
            max-width: 99%;
            width: 99%;
        }
        #scores-schedules-container .table-responsive-scores {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        #scores-schedules-container .league-header {
            margin-bottom: 15px;
        }
        #scores-schedules-container .scores-table {
            background: #5A4A9D;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            table-layout: auto;
        }
        #scores-schedules-container .scores-table thead th {
            background-color: rgba(147, 112, 219, 0.4);
            color: #F5F0FF;
            font-weight: 700;
            border-bottom: 2px solid rgba(181, 152, 214, 0.5);
            padding: 12px 8px;
            white-space: nowrap;
        }
        #scores-schedules-container .scores-table tbody td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 768px) {
            #scores-schedules-container .scores-table {
                font-size: 0.85rem;
            }
            #scores-schedules-container .scores-table thead th,
            #scores-schedules-container .scores-table tbody td {
                padding: 8px 4px;
            }
            #scores-schedules-container .team-name-text {
                font-size: 0.8rem !important;
            }
            #scores-schedules-container .team-record {
                display: none;
            }
        }
        #scores-schedules-container .scores-table tbody {
            background-color: #5A4A9D;
        }
        #scores-schedules-container .scores-table tbody tr {
            transition: background-color 0.2s;
        }
        #scores-schedules-container .scores-table tbody tr:hover {
            background-color: rgba(212, 197, 232, 0.2);
        }
        #scores-schedules-container .scores-table tbody td {
            vertical-align: middle;
            border-top: 1px solid rgba(181, 152, 214, 0.3);
            color: #F5F0FF;
            background-color: #5A4A9D;
        }
        #scores-schedules-container .scores-table tbody td[style*="text-align: center"] {
            color: #F5F0FF;
            font-weight: 600;
            background-color: #5A4A9D;
        }
        #scores-schedules-container .scores-table tbody td[style*="font-size: 1.6rem"] {
            color: #FFFFFF;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        #scores-schedules-container .winner-score {
            color: #FFD700 !important;
            font-weight: 900 !important;
            font-size: 1.8rem !important;
            text-shadow: 
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.4),
                2px 2px 4px rgba(0,0,0,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from {
                text-shadow: 
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 30px rgba(255, 215, 0, 0.4),
                    2px 2px 4px rgba(0,0,0,0.5);
            }
            to {
                text-shadow: 
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 25px rgba(255, 215, 0, 0.8),
                    0 0 35px rgba(255, 215, 0, 0.6),
                    2px 2px 4px rgba(0,0,0,0.5);
            }
        }
        #scores-schedules-container .winner-star-large {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 40px;
            height: 40px;
            z-index: 10;
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
            animation: starPulse 2s ease-in-out infinite;
        }
        @keyframes starPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }
        #scores-schedules-container .team-link {
            transition: opacity 0.2s;
        }
        #scores-schedules-container .team-link:hover {
            opacity: 0.8;
        }
        #scores-schedules-container .team-record {
            font-size: 0.9rem;
            opacity: 0.95;
        }
        #scores-schedules-container .team-name-desktop {
            flex: 1;
            min-width: 0;
        }
        #scores-schedules-container .team-name-mobile {
            font-weight: 600;
        }
        /* Mobile view - optimized layout for small screens */
        @media (max-width: 768px) {
            #scores-schedules-container {
                padding: 15px 10px;
            }
            #scores-schedules-container .league-header {
                margin-bottom: 12px;
            }
            #scores-schedules-container .league-header img {
                height: 45px !important;
            }
            #scores-schedules-container .league-header span {
                font-size: 1.2rem !important;
            }
            #scores-schedules-container .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            #scores-schedules-container .scores-table {
                font-size: 0.85rem;
                min-width: 600px;
            }
            #scores-schedules-container .scores-table th {
                padding: 10px 6px !important;
                font-size: 0.75rem;
                white-space: nowrap;
            }
            #scores-schedules-container .scores-table td {
                padding: 10px 6px !important;
            }
            #scores-schedules-container .team-name-desktop {
                display: none !important;
            }
            #scores-schedules-container .team-name-mobile {
                display: inline !important;
                font-size: 0.9rem;
            }
            #scores-schedules-container .team-abbrev {
                display: none !important;
            }
            #scores-schedules-container .team-link img {
                width: 28px !important;
                height: 28px !important;
            }
            #scores-schedules-container .team-record {
                font-size: 0.8rem;
            }
            #scores-schedules-container .scores-table tbody td[style*="text-align: center"] {
                font-size: 0.9rem;
            }
        }
        /* Very small mobile screens */
        @media (max-width: 480px) {
            #scores-schedules-container {
                padding: 12px 8px;
            }
            #scores-schedules-container .scores-table {
                font-size: 0.8rem;
                min-width: 550px;
            }
            #scores-schedules-container .scores-table th {
                padding: 8px 4px !important;
                font-size: 0.7rem;
            }
            #scores-schedules-container .scores-table td {
                padding: 8px 4px !important;
            }
            #scores-schedules-container .team-link img {
                width: 24px !important;
                height: 24px !important;
            }
            #scores-schedules-container .team-name-mobile {
                font-size: 0.85rem;
            }
            #scores-schedules-container .team-record {
                font-size: 0.75rem;
            }
        }
    </style>
</body>
</html>
